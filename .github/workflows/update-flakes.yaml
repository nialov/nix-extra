# From:
# https://github.com/nix-community/NixOS-WSL/blob/main/.github/workflows/update-flakes.yml
---
on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 0"

jobs:
  update-flakes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          # Nix Flakes doesn't work on shallow clones
          fetch-depth: 0

      - uses: DeterminateSystems/nix-installer-action@v2
        with:
          extra-conf: |
            system-features = nixos-test benchmark big-parallel kvm
            access-tokens = github.com=${{ github.token }}

      - uses: DeterminateSystems/update-flake-lock@v21
        with:
          pr-title: "Update flake.lock" # Title of PR to be created
          pr-labels: | # Labels to be set on the PR
            dependencies
            automated
          token: ${{ secrets.GH_TOKEN_FOR_UPDATES }}
      # - name: Update flakes âŒ›
      #   run: nix flake update

      # - name: Create Pull Request ðŸ“¨
      #   id: cpr
      #   uses: peter-evans/create-pull-request@v3
      #   with:
      #     commit-message: Update flakes
      #     committer: GitHub <noreply@github.com>
      #     author: github-actions <actions@users.noreply.github.com>
      #     signoff: false
      #     branch: flake-updates
      #     delete-branch: true
      #     title: "Update flakes"
      #     body: |
      #       Update report
      #       - Updated with *today's* date
      #       - Auto-generated by [create-pull-request][1]

      #       [1]: https://github.com/peter-evans/create-pull-request

      # - name: Check outputs
      #   run: |
      #     echo \
      #       "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
      #     echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
